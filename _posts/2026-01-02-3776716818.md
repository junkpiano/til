---
layout: post
title: Windows + WSL2 + k3s + Helm + Argo CD
date: 2026-01-02 16:36:16 +0000
category: windows
---

## （sudo kubectl 前提 / port-forward なし / GUI 常設）

この記事では、**Windows 上の WSL2(Ubuntu) に k3s を構築し、  
Helm + Argo CD を使った GitOps 環境を、port-forward なしで GUI 常設する方法**をまとめます。

実際にハマったポイントを踏まえ、**再現性を最優先**で書いています。

---

## 前提ポリシー（重要）

- k3s は **開発用 single-node クラスタ**
- **サーバー（WSL）側では `sudo kubectl` を基本とする**
- kubeconfig は `/etc/rancher/k3s/k3s.yaml` を正とする
- 権限調整で無理に一般ユーザーへ寄せない
- Windows 側は「入口（Ingress / GUI）」に専念する

> この方針は k3s 公式ドキュメントの設計思想と一致しています。

---

## ゴール（完成形）

- WSL2(Ubuntu) 上で k3s が稼働
- サーバー操作は `sudo kubectl`
- Argo CD を **Ingress(Traefik)** で常設公開
- `kubectl port-forward` は使わない
- WSL の IP 変更にも耐える
- Windows ブラウザから  
  `http://argocd.localhost` にアクセス可能

---

## 1. WSL2 / Ubuntu の準備（Windows）

### WSL2 インストール（未導入の場合）
```powershell
wsl --install
````

### 状態確認

```powershell
wsl --list --verbose
```

* Ubuntu が存在すること
* Version が `2` であること

---

## 2. Ubuntu 初期セットアップ（WSL）

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl ca-certificates gnupg lsb-release
```

---

## 3. k3s インストール（WSL）

### 3.1 インストール

```bash
curl -sfL https://get.k3s.io | sh -
```

### 3.2 起動確認（公式どおり）

```bash
sudo kubectl get nodes
```

`Ready` が出れば k3s は正常です。

---

## 4. k3s と sudo kubectl について

k3s は以下を **root 管理**する設計です：

* `/etc/rancher/k3s/k3s.yaml`
* containerd
* CNI / Traefik

そのため：

* `sudo kubectl` が基本
* permission denied は異常ではない
* 開発環境では権限調整より再現性を優先する

---

## 5. Helm インストール（WSL）

```bash
curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
helm version
```

---

## 6. Argo CD インストール（sudo kubectl）

### 6.1 namespace 作成

```bash
sudo kubectl create namespace argocd
```

### 6.2 マニフェスト適用

```bash
sudo kubectl apply -n argocd \
  -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

### 6.3 起動確認

```bash
sudo kubectl get pods -n argocd
sudo kubectl get svc  -n argocd
```

---

## 7. Argo CD を Ingress で常設公開（port-forward 不要）

k3s には Traefik が標準で有効になっています。

### 7.1 argocd-server を http モードにする

```bash
sudo kubectl -n argocd patch deployment argocd-server \
  --type='json' \
  -p='[
    {"op":"add","path":"/spec/template/spec/containers/0/args/-","value":"--insecure"}
  ]'

sudo kubectl rollout restart deployment argocd-server -n argocd
```

---

### 7.2 Ingress 作成（Traefik）

```bash
sudo kubectl apply -f - <<'EOF'
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd
  namespace: argocd
  annotations:
    kubernetes.io/ingress.class: traefik
spec:
  rules:
  - host: argocd.localhost
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              number: 80
EOF
```

確認：

```bash
sudo kubectl get ingress -n argocd
sudo kubectl describe ingress argocd -n argocd
```

---

## 8. WSL 内で疎通確認（最重要）

Ingress が正しく動いているかを **WSL 内から直接確認**します。

```bash
curl -H "Host: argocd.localhost" http://127.0.0.1
```

HTML が返れば、
**k3s + Traefik + Argo CD は完成**です。

---

## 9. Windows hosts の編集

管理者でメモ帳を起動：

```powershell
notepad C:\Windows\System32\drivers\etc\hosts
```

末尾に追記：

```
127.0.0.1 argocd.localhost
```

確認：

```powershell
ping argocd.localhost
```

---

## 10. Windows → WSL への中継（Ingress 用 80番）

**注意：k8s API(6443) とは別です。**

管理者 PowerShell：

```powershell
$wslIp = (wsl hostname -I).Trim().Split(" ")[0]

netsh interface portproxy reset

netsh interface portproxy add `
  v4tov4 `
  listenaddress=127.0.0.1 `
  listenport=80 `
  connectaddress=$wslIp `
  connectport=80
```

確認：

```powershell
netsh interface portproxy show all
```

---

## 11. ブラウザから Argo CD にアクセス

```
http://argocd.localhost
```

ログイン情報取得（WSL）：

```bash
sudo kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d && echo
```

* user: `admin`
* password: 上記で取得した値

---

## 12. WSL IP 変更に追従する（Windows スクリプト）

WSL の IP は再起動で変わるため、portproxy を更新するスクリプトを用意します。

### 12.1 スクリプト作成

`%USERPROFILE%\update-argocd-portproxy.ps1`

```powershell
# ==========================================================
# k3s on WSL portproxy updater
# - API Server : 127.0.0.1:6443 -> WSL:6443
# - Ingress    : 127.0.0.1:80   -> WSL:80
# ==========================================================

Write-Host "Starting k3s portproxy updater..." -ForegroundColor Cyan

# WSL を起動（IP 取得のため）
wsl -e bash -c "true" | Out-Null

# WSL の IP を取得
$wslIp = (wsl hostname -I).Trim().Split(" ")[0]

if (-not $wslIp) {
    Write-Error "WSL IP address not found"
    exit 1
}

Write-Host "WSL IP detected: $wslIp"

# 既存の portproxy をリセット
netsh interface portproxy reset | Out-Null

# ----------------------------------------------------------
# k3s API Server (kubectl / Lens / VS Code 用)
# ----------------------------------------------------------
netsh interface portproxy add `
  v4tov4 `
  listenaddress=127.0.0.1 `
  listenport=6443 `
  connectaddress=$wslIp `
  connectport=6443

Write-Host "API portproxy updated : 127.0.0.1:6443 -> $wslIp:6443" -ForegroundColor Green

# ----------------------------------------------------------
# Ingress (Argo CD / Web UI 用)
# ----------------------------------------------------------
netsh interface portproxy add `
  v4tov4 `
  listenaddress=127.0.0.1 `
  listenport=80 `
  connectaddress=$wslIp `
  connectport=80

Write-Host "Ingress portproxy updated : 127.0.0.1:80 -> $wslIp:80" -ForegroundColor Green

Write-Host "k3s portproxy update completed." -ForegroundColor Cyan
```

実行：

```powershell
powershell -ExecutionPolicy Bypass -File $env:USERPROFILE\update-argocd-portproxy.ps1
```

---

## 13. まとめ

* k3s は **sudo kubectl 前提**で扱うのが最も安定
* 権限調整でハマるより、設計思想に乗る
* Ingress + hosts + portproxy で GUI を常設
* port-forward に依存しないことで開発体験が向上
* Argo CD を起点に GitOps へ自然に拡張できる

---

## 次にやると良いこと（続編ネタ）

* Helm values を GitOps 管理
* app-of-apps パターン
* cert-manager による HTTPS 化
* k3s → EKS/GKE 移行時の差分整理



---
[discussion](https://github.com/junkpiano/til/issues/45)
